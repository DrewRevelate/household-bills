rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is in the allowed users list
    function isAllowedUser() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/allowedUsers/$(request.auth.uid));
    }

    // Check if user is an admin
    function isAdmin() {
      return isAllowedUser() &&
        get(/databases/$(database)/documents/allowedUsers/$(request.auth.uid)).data.role == 'admin';
    }

    // Allowed users collection
    // - Users can read their own document
    // - Users can create/update their own document (self-registration for allowed contacts)
    // - Only admin can delete any document
    match /allowedUsers/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Allow user to create or update their own document (bootstrap + recovery)
      allow create, update: if isAuthenticated() && request.auth.uid == userId;
      // Only admin can delete
      allow delete: if isAdmin();
    }

    // Bills collection - only allowed users can read/write
    match /bills/{billId} {
      allow read, write: if isAllowedUser();
    }

    // Household members collection
    match /members/{memberId} {
      allow read: if isAllowedUser();
      allow write: if isAllowedUser();
    }

    // Household settings
    match /settings/{settingId} {
      allow read, write: if isAllowedUser();
    }

    // Settlement records - only admin can write (forgive/clear debts)
    match /settlementRecords/{recordId} {
      allow read: if isAllowedUser();
      allow write: if isAdmin();
    }
  }
}
